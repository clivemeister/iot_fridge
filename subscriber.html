<!DOCTYPE HTML>
<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
<script>
	setTimeout(pollForMission, 3000);  // every few seconds, check to see if a mission is available
	var myfqdn='${fqdn}'
	var state="noMission"
	function pollForMission() {
		$.get('http://${fqdn}:8080/fridgeCheckRestock', restockCallback);
	}
	function restockCallback(data, restockNeeded) {
		if (state==="noMission") {
			if (data==="True") {
				$('#restockMessage').html('Fridge needs restocking!  Select below to take this mission.');
				$('#agreeToRestock').show()
				$('#performRestock').hide()
				state="restockAvailable"
			} else {
				$('#restockMessage').html('No mission available.  Fridges currently have enough stock.'); 
				$('#agreeToRestock').hide()
				$('#performRestock').hide()
				state="noMission"
			}
		} else if (state==="missionUnderway") {   // we have a mission underway
			$('#restockMessage').html('You have agreed to restock the fridge, and your bond has been placed in escrow on the blockchain.  Complete the mission for your bond to be returned, and your bounty paid out.')
			$('#performRestock').show(1000)
		}
		setTimeout(pollForMission, 3000);
	}

        setTimeout(pollForBalance, 5000);  // every 5 seconds
        function pollForBalance() {
                $.get('/subscriberAccountBalance', accountCallback);
        }
        function accountCallback(data, textStatus) {
                $('#subscriberAccountBalance').html("Subscriber account balance: "+data+" mBTC");
                setTimeout(pollForBalance, 5000);
        }

	$(document).ready(function() {
		$("#takeMission").click(function() {
			$("#agreeToRestock").hide(1000)
                        $.ajax({
                                method: "PUT",
                                url: "/statusupdate/agreeToRestock/",
                                contentType: "application/json",
                                error: function(jqXHR, status) {
                                        console.log(jqXHR)
                                        alert('fail in agreeToRestock PUT: ' + status.code)
                                }
                        })
			state="missionUnderway"
		})

		$("#performRestock").click(function() {
			$("#agreeToRestock").hide(1000)
			$.ajax({
				method: "PUT",
				url: "/statusupdate/restockFridge/all_cans",
				contentType: "application/json",
				success: function(data, status, jqXHR) {
					alert('Congratulations!  You have successfully restocked the fridge!  Your bond will shortly be returned, and your bonus paid out.  Thank you for your service!')
				},
				error: function(jqXHR, status) {
					console.log(jqXHR)
					alert('fail in performRestock PUT: ' + status.code)
				}
			})
			state="noMission"
		})
	})
</script>
</head>
<body>

<h2>The Subscriber App</h2>
<p>Subscribers are notified when the fridge needs restocking.  They can then decide to accept the restocking
request.  Once they have done this, they use a blockchain Smart Contract to put a bond in escrow while they
complete the restocking.  After the restocking has completed successfully, the bond is released back to them
from escrow, and in addition the subscriber receives a bounty payment for their work.</p>
<h3>Status message</h3>
<div id="restockMessage">
No status to display
</div>
<div id="agreeToRestock" style="display: none" >
	<button id="takeMission">Agree to restock</button>
</div>
<div id="performRestock" style="display: none">
	<button id="performMission">Complete the restock</button>
</div>
<h3>Wallet</h3>
<div id="subscriberAccountBalance">0.00 mETH</div>
</body>
</html>
