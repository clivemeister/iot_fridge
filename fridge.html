<!DOCTYPE HTML>
<html>
<head>
<style>
#fridge {
    float: left;
    width: 420px;
    height: 255px;
    margin: 10px;
    padding: 10px;
    border: 1px solid black;
}
#table {
    float: left;
    width: 330px;
    height: 135px;
    margin: 10px;
    padding: 10px;
    border: 1px solid black;
}
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.js"></script>
<script>
	setTimeout(pollForBalance, 5000);  // every 5 seconds
	myfqdn='${fqdn}'
	function pollForBalance() {
		$.get('http://${fqdn}:8080/fridgeAccountBalance', accountCallback);
	}
	function accountCallback(data, textStatus) {
		$('#accountBalance').html("Fridge account balance: "+data+" mBTC");
		setTimeout(pollForBalance, 5000);
	}

	var fridge_canCount=${totalCanCount}
	var fridgeCapacity=10
	function allowDrop(ev) {
		ev.preventDefault();
	}
	function allowDropInFridge(ev) {
		if (fridge_canCount<fridgeCapacity) {
			ev.preventDefault();
		}
	}

	function dragFromSomewhere(ev) {
		ev.dataTransfer.setData("text/plain", ev.target.id);
		if (ev.path[1].id == "fridge") {
			fridge_canCount--
			$.ajax({
				type: "PUT",
				url: "/fridgeupdate/dragFromFridge/"+ev.target.id,
				contentType: "application/json; charset=utf-8",
				error: function(jqXHR, status) {
					console.log(jqXHR)
					alert('fail in dragFromSomewhere PUT: ' + status.code)
				}
			})
		}
	}
	function drag(ev) {
		ev.dataTransfer.setData("text/plain", ev.target.id);
	}
	function dropInFridge(ev) {
		if (fridge_canCount<fridgeCapacity) {
			ev.preventDefault();
			var data = ev.dataTransfer.getData("text/plain");
			fridge_canCount++
			ev.target.appendChild(document.getElementById(data));
			$.ajax({
				type: "PUT",
				url: "/fridgeupdate/dropInFridge/"+data,
				contentType: "application/json; charset=utf-8",
				error: function(jqXHR, status) {
					console.log(jqXHR)
					alert('fail in dropInFridge PUT: ' + status.code)
				}
			})
		}
	}
	function dropOnTable(ev) {
		ev.preventDefault();
		var data = ev.dataTransfer.getData("text/plain");
		ev.target.appendChild(document.getElementById(data));
	}
	$(function() {
		function addCan(canID) {
			imgString='<img src="'+canID+'.gif" draggable="true" ondragstart="dragFromSomewhere(event)" id="'+canID+'" width="80" height="120">'
			$("#fridge").append(imgString)
			fridge_canCount++
		}

		$("button.drinkCan").click(function() {
			$("#table img:last-child").remove()
		})

		$("button.restockRedCan").click(function() {
			if (fridge_canCount<fridgeCapacity) {
				addCan("red_can")
			}
		})

		$("button.restockGreenCan").click(function() {
			if (fridge_canCount<fridgeCapacity) {
				$("#fridge").append('<img src="green_can.gif" draggable="true" ondragstart="dragFromSomewhere(event)" id="green_can" width="80" height="120">')
				fridge_canCount++
			}
		})

		$("button.restockBlueCan").click(function() {
			if (fridge_canCount<fridgeCapacity) {
				$("#fridge").append('<img src="blue_can.gif" draggable="true" ondragstart="dragFromSomewhere(event)" id="blue_can" width="80" height="120">')
				fridge_canCount++
			}
		})
	})
</script>
</head>
<body>

<h2>The Virtual Fridge</h2>
<p>Drag the cans back and forth between the fridge and the table.
When the cans are on the table, you can drink them!</p>
<h3>Fridge</h3>
<div id="fridge" ondrop="dropInFridge(event)" ondragover="allowDropInFridge(event)">
	%for i in range(redCanCount):
		<img src="red_can.gif" draggable="true" ondragstart="dragFromSomewhere(event)" id="red_can" width="80" height="120">
	%endfor
	%for i in range(greenCanCount):
  		<img src="green_can.gif" draggable="true" ondragstart="dragFromSomewhere(event)" id="green_can" width="80" height="120">
	%endfor
	%for i in range(blueCanCount):
		<img src="blue_can.gif" draggable="true" ondragstart="dragFromSomewhere(event)" id="blue_can" width="80" height="120">
	%endfor
</div>
<h3 id="accountBalance">Fridge account balance: ${balance} mBTC</h3>
<button class="restockRedCan">Restock red can</button>
<button class="restockGreenCan">Restock green can</button>
<button class="restockBlueCan">Restock blue can</button>
<br>
<h3>Table</h3>
<button class="drinkCan">Drink can</button>
<div id="table" ondrop="dropOnTable(event)" ondragover="allowDrop(event)"></div>
</body>
</html>
